# TTq
# H 桥电流环换向：0 点方向判断锁存问题说明

## 背景
在 H 桥电流环换向过程中，参考电流 `ref_mA` 从**阶跃值切到 0** 的瞬间，如果仍然用 `ref_mA` 的符号来决定“真实电流通道”：
- `ref_mA > 0` 时取 `Cur[1]`
- `ref_mA <= 0` 时取 `Cur[0]`

则在电流较大时，**切 0 瞬间会出现过冲**。  
因此需要在 `ref_mA` 由阶跃切至 0 的时刻，对方向判断进行**锁存**：即 **0 时刻沿用上一采样时刻的“眼睛”（通道选择）**，避免把另一方向的电流值误当成真实值参与运算。

---

## 通道选择规则（两种写法对比）

### 情况 1：以 `ref_mA > 0` 为正向判断
- `ref_mA > 0`：实际电流值 = `Cur[1]`
- `ref_mA <= 0`：实际电流值 = `Cur[0]`

#### 现象
当电流从 `+2A` 切向 `0A` 时，会出现**冲到 +5A** 的过冲。

#### 原因分析
在 `0 → +2 → 0` 的切换瞬间，判断语句会把“真实值”从 `Cur[1]` 切到 `Cur[0]`（方向反了）。

- 正常阶段（`+2A` 时）误差：
  - `Target - Real = 2 - x > 0`（其中 `x` 为 `Cur[1]` 相关的真实电流测量）

- 切 0 瞬间（由于取错通道，等价于拿到了 `-Cur[0]` 参与运算）：
  - `Target - Real = 0 - (-Cur[0]) > 0`

由于位置式 PID 看到误差突然变“大正值”，会**瞬间拉升输出**，导致电流冲到 `+5A`。  
同时可以观测到：`Cur[0]` 通道的电流值在此时仍然非常大。

---

### 情况 2：以 `ref_mA >= 0` 为正向判断（与情况 1 相反）
- `ref_mA >= 0`：实际电流值 = `Cur[1]`
- `ref_mA < 0`：实际电流值 = `Cur[0]`

#### 现象
当电流从 `-2A` 切向 `0A` 时，会出现**冲到 -5A** 的过冲。

#### 原因分析
在 `0 → -2 → 0` 的切换瞬间，判断语句会把“真实值”从 `Cur[0]` 切到 `Cur[1]`（同样方向错置）。

- 正常阶段（`-2A` 时）误差：
  - `Target - Real = -2 - (-Cur[0]) < 0`

- 切 0 瞬间（由于取错通道，变成用 `Cur[1]` 参与运算）：
  - `Target - Real = 0 - Cur[1] < 0`

位置式 PID 会将输出瞬间拉向负方向，导致电流冲到 `-5A`。  
同时可以观测到：`Cur[1]` 通道的电流值在此时仍然非常大。

---

## 结论
在电流从非零切到 0 的瞬间，如果用 `ref_mA` 的符号直接切换测量通道，容易把反向通道的大电流值误当作真实值，造成 PID 误差突变，从而出现严重过冲。

**建议：在 0 点换向时对方向/通道选择进行锁存，0 时刻沿用上一采样时刻的通道选择。**
